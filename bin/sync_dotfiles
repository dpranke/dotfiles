#!/bin/bash

function usage() {
  echo "usage: sync_dotfiles [-dhnruv] [ -D dropbox-dir ] [ -U home-dir ] "
  echo "  -h -> show-usage"
  echo "  -d -> refresh home from dropbox"
  echo "  -n -> no-execute"
  echo "  -r -> use-remote-home-dir (same as -U $HOME/remote)"
  echo "  -u -> refresh dropbox from home"
  echo "  -v -> verbose"
  exit 1
}

if [ -d "$HOME/My Documents/My Dropbox" ]
then
  dropbox="$HOME/My Documents/My Dropbox"
elif [ -d "$HOME/Dropbox" -o -L "$HOME/Dropbox" ]
then
  dropbox="$HOME/Dropbox"
else
  dropbox=/Dropbox
fi
dropbox=$dropbox/Shared/dotfiles
if [ ! -d $dropbox ]
then
    echo "Couldn't find your Dropbox dotfiles dir."
    exit 1
fi

DHOME=$HOME
opt_n=0
opt_u=0
opt_d=0
opt_v=1
while getopts dD:hnruU:v arg
do
  case "$arg" in
    d) opt_d=1 ;;
    D) dropbox=$OPTARG ; echo "dropbox = $dropbox" ;;
    h) usage   ;;
    n) opt_n=1 ;;
    r) DHOME=$HOME/remote ; echo "DHOME = $DHOME" ;;
    u) opt_u=1 ;;
    U) DHOME=$OPTARG ; echo "DHOME = $DHOME" ;;
    v) opt_v=1 ;;
    *) usage ;;
  esac
done

function maybe_mkdir() {
    dir="$1"
    if [ \( ! -d "$dir" \) -a \( ! -f "$dir" \) ]
    then
        if [ $opt_n -eq 1 -o $opt_v -eq 1 ]
        then
            echo mkdir -p "$dir"
        fi
        if [ $opt_n -eq 0 ]
        then
            mkdir -p "$dir"
            if [ ! $? ]
            then
              echo "mkdir -p \"$dir\" failed: $?"
              exit $?
            fi
        fi
    fi
}

function copynewer() {
  f="$1"
  if [ \( $opt_d -eq 1 \) -o \( \( $opt_u -eq 0 \) -a  "$dropbox/$f" -nt "$DHOME/$f" \) ]
  then
    if [ $opt_n -eq 1 -o $opt_v -eq 1 ]
    then
      echo "dropbox -> home   : $f"
    fi
    if [ $opt_n -eq 0 ]
    then
      cp -p "$dropbox/$f" "$DHOME/$f"
      if [ ! $? ]
      then
        echo "cp -p \"$dropbox/$f\" \"$DHOME/$f\" failed: $?"
        exit $?
      fi
    fi
  elif [ \( $opt_u -eq 1 \) -o \( "$DHOME/$f" -nt "$dropbox/$f" \) ]
  then
    if [ $opt_n -eq 1 -o $opt_v -eq 1 ]
    then
     echo "home    -> dropbox: $f"
    fi
    if [ $opt_n -eq 0 ]
    then
      cp -p "$DHOME/$f" "$dropbox/$f"
      if [ ! $? ]
      then
        echo "cp -p \"$DHOME/$f\" \"$dropbox/$f\" failed: $?"
        exit $?
      fi
    fi
  fi
}

cd "$dropbox"
for f in $(find . -name .git -prune -o -type f -a \! -name '*.swp' -print)
do
    d=$(dirname "$f")
    maybe_mkdir "$DHOME/$d"
    copynewer "$f"
done
