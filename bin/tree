#!/bin/bash
#
# usage: tree
#

if [ -z "$src" ]
then
    echo "\$src needs to be set to find your trees"
    exit 1
fi

findrev() {
    if git log -1 "$1" > /dev/null 2>& 1
    then
      currev=$(git log -1 $1 | awk '$1 == "git-svn-id:" { sub("^.*@", "", $2); print $2; }' | tail -1)
    else
      currev="-1"
    fi
}

gitbranch() {
    b=$(git symbolic-ref HEAD 2>/dev/null)
    branch=$(echo ${b##refs/heads/})
    let "local = 0"
    findrev HEAD~$local
    while [ -z "$currev" ]
    do
        let "local += 1"
        findrev HEAD~$local
    done

    if [ $currev = -1 ]
    then
       echo -n "$branch => ??"
    elif [ $local = 0 ]
    then
       echo -n "$branch => r$currev (nothing local)"
    else
       echo -n "$branch => r$currev +$local"
    fi
    currev=""
}

svnrev() {
    currev=$(svn info $1 | awk '$1 == "Revision:" { print $2 }')
    echo -n "$currev"
}

depsrev() {
    currev=$(awk '$1 == "\"'$3'\":" { print substr($2, 2, length($2)-3) }' $1)
    echo -n "$currev"
}

cd $src
if [ -n "$*" ]
then
    CHECKOUTS="$*"
else
    CHECKOUTS="repos $(ls -1 $src | egrep '^(wk|c|bl)' | egrep -v crockpot)"
fi

for i in $CHECKOUTS
do
    echo "$i:"
    if [ "$i" = "repos" ]
    then
       echo -n "  chrome: " 
       svnrev svn://svn.chromium.org/chrome/trunk/src chrome
       echo -n " (lkgr r$(curl -s http://chromium-status.appspot.com/lkgr), "
       echo "blink r$(curl -s http://blink-status.appspot.com/lkgr))"

       echo -n "   blink: "
       svnrev svn://svn.chromium.org/blink/trunk blink
       deps=$(svn cat svn://svn.chromium.org/chrome/trunk/src/DEPS | \
              awk '$1 == "\"webkit_revision\":" { print substr($2, 2, 6) }')
       echo " (deps r$deps)"
    elif [ -e "$src/$i/src/.git" ]
    then
        cd $src/$i/src
        echo -n "  chrome: " 
        gitbranch
        echo
        if [ -e "$src/$i/src/third_party/WebKit/.git" ]
        then
            cd $src/$i/src/third_party/WebKit
            echo -n "   blink: "
            gitbranch
            echo
        fi
    elif [ -e "$src/$i/.git" ]
    then
        cd $src/$i
        echo -n "      ??: "
        gitbranch
    elif [ -e "$src/$i/src/.svn" ]
    then
        echo -n "  chrome: "
        svnrev "$src/$i/src" 
        echo -n " (deps "
        depsrev "$src/$i/src/DEPS" webkit webkit_revision
        echo ")"
        echo -n "  webkit: "
        svnrev "$src/$i/src/third_party/WebKit" 
        echo 
    elif [ -e "$src/$i/.svn" -a -e "$src/$i/LayoutTests" ]
    then
        echo -n "  webkit: "
        svnrev "$src/$i" 
        echo 
    fi
    echo
done
